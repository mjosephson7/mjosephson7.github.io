<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - OFMC</title>
    <link rel="stylesheet" href="assets/css/styles.css">
    <link rel="stylesheet" href="assets/css/admin-dashboard.css">
    <link rel="icon" href="assets/img/favicon.ico" type="image/x-icon" media="(prefers-color-scheme: light)">
    <link rel="icon" href="assets/img/favicon-dark.ico" type="image/x-icon" media="(prefers-color-scheme: dark)">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    
    <!-- Firebase SDK -->
    <script type="module" src="firebase-config.js"></script>
</head>
<body>
    <div class="admin-header">
        <h1><i class="fa fa-tachometer"></i> OFMC Admin Dashboard</h1>
        <div class="admin-nav">
            <span id="welcomeMessage">Welcome, Admin</span>
            <button class="logout-btn" onclick="logout()">
                <i class="fa fa-sign-out"></i> Logout
            </button>
        </div>
    </div>

    <div class="dashboard-container">
        <!-- Dashboard Grid -->
        <div class="dashboard-grid" style="max-width: 1200px; margin: 0 auto;">
            <!-- Announcements Management -->
            <div class="dashboard-card">
                <h3><i class="fa fa-newspaper-o"></i> Announcements</h3>
                <p>Manage announcements displayed on the website.</p>
                
                <!-- Add New Announcement -->
                <div style="margin-bottom: 1.5rem; padding: 1rem; background: #f7fafc; border-radius: 8px;">
                    <h4 style="margin: 0 0 1rem 0; color: #2d3748;">Add New Announcement</h4>
                    <div style="margin-bottom: 0.75rem;">
                        <label for="announcementTitle" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Title:</label>
                        <input type="text" id="announcementTitle" placeholder="Announcement title..." style="width: 100%; padding: 0.5rem; border: 1px solid #e2e8f0; border-radius: 5px;">
                    </div>
                    <div style="margin-bottom: 0.75rem;">
                        <label for="announcementContent" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Content:</label>
                        <textarea id="announcementContent" placeholder="Announcement content..." style="width: 100%; padding: 0.5rem; border: 1px solid #e2e8f0; border-radius: 5px; min-height: 80px; resize: vertical;"></textarea>
                    </div>
                    <button class="btn btn-success" onclick="addAnnouncement()">Add Announcement</button>
                </div>

                <!-- Current Announcements -->
                <div>
                    <h4 style="margin: 0 0 1rem 0; color: #2d3748;">Current Announcements</h4>
                    <div id="announcementsList" style="max-height: 300px; overflow-y: auto;">
                        <div style="text-align: center; color: #6b7280; padding: 1rem; font-style: italic;">
                            No announcements created yet.
                        </div>
                    </div>
                </div>
            </div>

            <!-- Banner Management -->
            <div class="dashboard-card">
                <h3><i class="fa fa-bullhorn"></i> Notification Banner</h3>
                <p>Manage the notification banner displayed at the top of the website.</p>
                
                <!-- Banner Settings -->
                <div style="margin-bottom: 1.5rem; padding: 1rem; background: #f7fafc; border-radius: 8px;">
                    <h4 style="margin: 0 0 1rem 0; color: #2d3748;">Banner Settings</h4>
                    
                    <div style="margin-bottom: 0.75rem;">
                        <label for="bannerEnabled" style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="checkbox" id="bannerEnabled" style="margin: 0;">
                            <span style="font-weight: 500;">Enable Banner</span>
                        </label>
                    </div>
                    
                    <div style="margin-bottom: 0.75rem;">
                        <label for="bannerColor" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Color:</label>
                        <select id="bannerColor" style="width: 100%; padding: 0.5rem; border: 1px solid #e2e8f0; border-radius: 5px;">
                            <option value="yellow">Yellow (Warning)</option>
                            <option value="red">Red (Alert)</option>
                        </select>
                    </div>
                    
                    <div style="margin-bottom: 0.75rem;">
                        <label for="bannerMessage" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Message:</label>
                        <input type="text" id="bannerMessage" placeholder="Enter banner message..." style="width: 100%; padding: 0.5rem; border: 1px solid #e2e8f0; border-radius: 5px;">
                    </div>
                    
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="btn btn-success" onclick="saveBannerSettings()">Save Banner</button>
                        <button class="btn btn-secondary" onclick="previewBanner()">Preview</button>
                    </div>
                </div>

                <!-- Banner Preview -->
                <div>
                    <h4 style="margin: 0 0 1rem 0; color: #2d3748;">Current Status</h4>
                    <div id="bannerStatus" style="padding: 1rem; border: 1px solid #e2e8f0; border-radius: 8px; background: white;">
                        <p style="margin: 0; color: #6b7280; font-style: italic;">Banner is currently disabled</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Check authentication on page load
        function checkAuthentication() {
            const isAuthenticated = sessionStorage.getItem('adminAuthenticated');
            const username = sessionStorage.getItem('adminUsername');
            
            if (!isAuthenticated || isAuthenticated !== 'true') {
                window.location.href = 'admin-login.html';
                return;
            }
            
            // Update welcome message
            if (username) {
                const welcomeMsg = document.getElementById('welcomeMessage');
                welcomeMsg.textContent = `Welcome, ${username.charAt(0).toUpperCase() + username.slice(1)}`;
            }
            
            // Auto-logout after 2 hours of inactivity
            const loginTime = sessionStorage.getItem('loginTime');
            if (loginTime) {
                const loginDate = new Date(loginTime);
                const now = new Date();
                const hoursDiff = (now - loginDate) / (1000 * 60 * 60);
                
                if (hoursDiff > 2) {
                    logout();
                    return;
                }
            }
        }

        // Logout function
        function logout() {
            sessionStorage.removeItem('adminAuthenticated');
            sessionStorage.removeItem('adminUsername');
            sessionStorage.removeItem('loginTime');
            window.location.href = 'admin-login.html';
        }



        // Firebase functions
        // Announcements management functions
        async function addAnnouncement() {
            const titleInput = document.getElementById('announcementTitle');
            const contentInput = document.getElementById('announcementContent');
            
            const title = titleInput.value.trim();
            const content = contentInput.value.trim();
            
            if (!title || !content) {
                alert('Please fill in both title and content for the announcement.');
                return;
            }
            
            try {
                const newAnnouncement = {
                    title: title,
                    content: content,
                    date: new Date().toLocaleDateString('en-US', { 
                        year: 'numeric', 
                        month: 'long', 
                        day: 'numeric' 
                    }),
                    timestamp: Date.now()
                };
                
                await window.firebaseAddDoc(window.firebaseCollection(window.firebaseDB, 'announcements'), newAnnouncement);
                
                // Clear form
                titleInput.value = '';
                contentInput.value = '';
                
                // Refresh display
                await displayAnnouncements();
                
                alert('Announcement added successfully!');
            } catch (error) {
                console.error('Error adding announcement:', error);
                alert('Failed to add announcement. Please try again.');
            }
        }
        
        async function deleteAnnouncement(id) {
            if (!confirm('Are you sure you want to delete this announcement?')) {
                return;
            }
            
            try {
                await window.firebaseDeleteDoc(window.firebaseDoc(window.firebaseDB, 'announcements', id));
                
                // Refresh display
                await displayAnnouncements();
            } catch (error) {
                console.error('Error deleting announcement:', error);
                alert('Failed to delete announcement. Please try again.');
            }
        }
        
        async function displayAnnouncements() {
            const announcementsList = document.getElementById('announcementsList');
            
            try {
                const querySnapshot = await window.firebaseGetDocs(window.firebaseCollection(window.firebaseDB, 'announcements'));
                const announcements = [];
                
                querySnapshot.forEach((doc) => {
                    announcements.push({ id: doc.id, ...doc.data() });
                });
                
                // Sort by timestamp (newest first)
                announcements.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
                
                if (announcements.length === 0) {
                    announcementsList.innerHTML = `
                        <div style="text-align: center; color: #6b7280; padding: 1rem; font-style: italic;">
                            No announcements created yet.
                        </div>
                    `;
                    return;
                }
                
                announcementsList.innerHTML = announcements.map(announcement => `
                    <div style="border: 1px solid #e2e8f0; border-radius: 8px; padding: 1rem; margin-bottom: 0.75rem; background: white;">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem;">
                            <h5 style="margin: 0; color: #2d3748; font-weight: 600;">${announcement.title}</h5>
                            <div style="display: flex; gap: 0.5rem; align-items: center;">
                                <span style="font-size: 0.8rem; color: #6b7280;">${announcement.date}</span>
                                <button onclick="deleteAnnouncement('${announcement.id}')" style="background: #e53e3e; color: white; border: none; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.8rem; cursor: pointer;">Delete</button>
                            </div>
                        </div>
                        <p style="margin: 0; color: #4a5568; line-height: 1.5;">${announcement.content}</p>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error fetching announcements:', error);
                announcementsList.innerHTML = `
                    <div style="text-align: center; color: #e53e3e; padding: 1rem; font-style: italic;">
                        Failed to load announcements. Please check your Firebase configuration.
                    </div>
                `;
            }
        }

        // Banner management functions
        async function saveBannerSettings() {
            const enabled = document.getElementById('bannerEnabled').checked;
            const color = document.getElementById('bannerColor').value;
            const message = document.getElementById('bannerMessage').value.trim();
            
            if (enabled && !message) {
                alert('Please enter a banner message.');
                return;
            }
            
            const bannerSettings = {
                enabled: enabled,
                color: color,
                message: message
            };
            
            try {
                await window.firebaseSetDoc(window.firebaseDoc(window.firebaseDB, 'settings', 'banner'), bannerSettings);
                
                await updateBannerStatus();
                alert('Banner settings saved successfully!');
            } catch (error) {
                console.error('Error saving banner settings:', error);
                alert('Failed to save banner settings. Please try again.');
            }
        }
        
        function previewBanner() {
            const enabled = document.getElementById('bannerEnabled').checked;
            const color = document.getElementById('bannerColor').value;
            const message = document.getElementById('bannerMessage').value.trim();
            
            if (!enabled) {
                alert('Please enable the banner to preview it.');
                return;
            }
            
            if (!message) {
                alert('Please enter a banner message to preview.');
                return;
            }
            
            // Create temporary preview banner
            let previewBanner = document.getElementById('previewBanner');
            if (!previewBanner) {
                previewBanner = document.createElement('div');
                previewBanner.id = 'previewBanner';
                document.body.insertBefore(previewBanner, document.body.firstChild);
            }
            
            previewBanner.innerHTML = `
                <div class="notification-banner ${color}" style="position: fixed; top: 0; width: 100%; z-index: 10000;">
                    <div style="display: flex; align-items: center; justify-content: space-between; padding: 0.75rem 1rem; max-width: 1200px; margin: 0 auto;">
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fa fa-exclamation-circle" style="font-size: 1.1rem;"></i>
                            <span>${message}</span>
                        </div>
                        <button onclick="closePreview()" style="background: none; border: none; cursor: pointer; padding: 0.25rem; border-radius: 3px; font-size: 1rem;">
                            <i class="fa fa-times"></i>
                        </button>
                    </div>
                </div>
            `;
            
            // Auto-close preview after 5 seconds
            setTimeout(closePreview, 5000);
        }
        
        function closePreview() {
            const previewBanner = document.getElementById('previewBanner');
            if (previewBanner) {
                previewBanner.remove();
            }
        }
        
        async function loadBannerSettings() {
            try {
                const docRef = window.firebaseDoc(window.firebaseDB, 'settings', 'banner');
                const docSnap = await window.firebaseGetDoc(docRef);
                
                if (docSnap.exists()) {
                    const bannerSettings = docSnap.data();
                    document.getElementById('bannerEnabled').checked = bannerSettings.enabled || false;
                    document.getElementById('bannerColor').value = bannerSettings.color || 'yellow';
                    document.getElementById('bannerMessage').value = bannerSettings.message || '';
                } else {
                    // Set default values if document doesn't exist
                    document.getElementById('bannerEnabled').checked = false;
                    document.getElementById('bannerColor').value = 'yellow';
                    document.getElementById('bannerMessage').value = '';
                }
                
                await updateBannerStatus();
            } catch (error) {
                console.error('Error loading banner settings:', error);
                // Set default values if Firebase fails
                document.getElementById('bannerEnabled').checked = false;
                document.getElementById('bannerColor').value = 'yellow';
                document.getElementById('bannerMessage').value = '';
            }
        }
        
        async function updateBannerStatus() {
            const statusDiv = document.getElementById('bannerStatus');
            
            try {
                const docRef = window.firebaseDoc(window.firebaseDB, 'settings', 'banner');
                const docSnap = await window.firebaseGetDoc(docRef);
                
                if (docSnap.exists()) {
                    const bannerSettings = docSnap.data();
                    
                    if (bannerSettings.enabled && bannerSettings.message) {
                        statusDiv.innerHTML = `
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                <span style="display: inline-block; width: 12px; height: 12px; border-radius: 50%; background-color: #22c55e;"></span>
                                <span style="font-weight: 500; color: #22c55e;">Banner is active</span>
                            </div>
                            <p style="margin: 0; color: #4a5568;"><strong>Color:</strong> ${bannerSettings.color.charAt(0).toUpperCase() + bannerSettings.color.slice(1)}</p>
                            <p style="margin: 0; color: #4a5568;"><strong>Message:</strong> ${bannerSettings.message}</p>
                        `;
                    } else {
                        statusDiv.innerHTML = `
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <span style="display: inline-block; width: 12px; height: 12px; border-radius: 50%; background-color: #6b7280;"></span>
                                <span style="font-weight: 500; color: #6b7280;">Banner is disabled</span>
                            </div>
                        `;
                    }
                } else {
                    statusDiv.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <span style="display: inline-block; width: 12px; height: 12px; border-radius: 50%; background-color: #6b7280;"></span>
                            <span style="font-weight: 500; color: #6b7280;">Banner is disabled</span>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error updating banner status:', error);
                statusDiv.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <span style="display: inline-block; width: 12px; height: 12px; border-radius: 50%; background-color: #e53e3e;"></span>
                        <span style="font-weight: 500; color: #e53e3e;">Unable to connect to Firebase</span>
                    </div>
                `;
            }
        }

        // Initialize on page load
        window.addEventListener('load', async function() {
            checkAuthentication();
            await displayAnnouncements();
            await loadBannerSettings();
        });

        // Update activity every 30 seconds
        setInterval(function() {
            checkAuthentication();
        }, 30000);
    </script>
</body>
</html>